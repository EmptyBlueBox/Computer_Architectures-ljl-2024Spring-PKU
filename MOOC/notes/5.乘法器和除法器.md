# 第五章 - 乘法器和除法器

## 5.1 乘法的运算过程

### 较为简单的数字选择：二进制

二进制下不需要查 **乘法表**，只需要根据乘数的每一位是 0 还是 1，来抄一遍被乘数即可。

### 十进制和二进制运算的选择

ENIAC 采用十进制，导致电路复杂；EDVAC 经过冯诺依曼 1945 年在其《关于 EDVAC 的报告草案》中提出的 **二进制** ，简化了电路。

电子管是一种 **全或无** 设备（all-or-none），适合表示只有两个数值的系统，即二进制。

二进制可以大幅度地简化乘法和除法的运算过程。尤其是对于乘法，不再需要十进制乘法表，也不再需要两轮的加法。

必须要记住，十进制才是适合人使用的。因此，**输入输出设备** 需要承担二进制和十进制之间的转换工作。

### 运算过程的进一步调整

-   每个中间结果产生后直接与当前的乘积累加
-   每产生一个中间结果，**被乘数向左移动一位**

## 5.2 乘法器的实现

### 乘法器的实现结构

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.38.53@2x.png" alt="CleanShot 2024-03-27 at 13.38.53@2x" style="zoom:30%;" />

使用控制信号（Control Test）来控制是否要左移被乘数（Multiplicand）寄存器，被乘数寄存器与乘积（Product）寄存器经 ALU 相加，结果存入乘积寄存器。

控制信号根据乘数（Multiplier）寄存器的最低位来决定其逻辑，包括：

- 每乘一位，左移被乘数寄存器
- 如果最低位是 1，允许 ALU 进行加法运算，否则不允许
- 如果最低位是 1，允许乘积寄存器保存当前结果，否则不允许
- 每乘一位，右移乘数寄存器
- 是否终止运行 **（对应循环完成了 N 次）**

### 乘法器的工作过程

#### 乘法器的工作过程（初始化）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.40.10@2x.png" alt="CleanShot 2024-03-27 at 13.40.10@2x" style="zoom:30%;" />

位置不足，则以 0 补齐（图中斜体）。

#### 乘法器的工作过程（1a）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.41.11@2x.png" alt="CleanShot 2024-03-27 at 13.41.11@2x" style="zoom:30%;" />

乘数最低位为 1，则：

-   ALU 进行加法运算，输入是当前时刻的乘积寄存器与被乘数，然后加和
-   乘积寄存器在 **下一个时钟上升沿** ，因写入信号有效，乘积寄存器采样，保存新结果

#### 乘法器的工作过程（1b）

乘数最低位为 0，则直接跳过 1a。

#### 乘法器的工作过程（2）

准备被乘数，控制逻辑会给出左移的信号，那么在 **下一个时钟上升沿** 来临的时候，被乘数寄存器就会完成一次左移。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.43.27@2x.png" alt="CleanShot 2024-03-27 at 13.43.27@2x" style="zoom:30%;" />

#### 乘法器的工作过程（3）

准备乘数，控制逻辑会给出右移的信号，那么在 **下一个时钟上升沿** 来临的时候，乘数寄存器就会完成一次右移。

放心右移：一旦一个位使用过了，就再也不会使用了。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.43.51@2x.png" alt="CleanShot 2024-03-27 at 13.43.51@2x" style="zoom:30%;" />

#### 乘法器的工作过程（4）

检查循环是否结束，如果循环了四次就说明乘法完成（因为乘数是 4 位的）。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.45.28@2x.png" alt="CleanShot 2024-03-27 at 13.45.28@2x" style="zoom:30%;" />

#### 乘法器的工作过程（1、2、3、4） 第 2、3、4 轮

判断是否完成乘法：计数当前的循环次数，如果循环了 4 次就说明乘法完成。

### N 位乘法器的工作流程图

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.49.57@2x.png" alt="CleanShot 2024-03-27 at 13.49.57@2x" style="zoom:30%;" />

## 5.3 乘法器的优化 1：加法移位并行

### N 位乘法器的工作流程图

时钟周期很多，3 个时钟周期。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.51.45@2x.png" alt="CleanShot 2024-03-27 at 13.51.45@2x" style="zoom:30%;" />

### 加法移位并行

一个重要事实：时钟上升沿到来时，寄存器才会根据输入改变其内容。

根据这个事实，我们可以同时执行 1、2、3、4 步骤，即在一个时钟周期内完成一次乘法，也即在时钟上升沿到来之前：

-   直接给出被乘数寄存器的左移信号

-   直接给出乘数寄存器的右移信号

-   根据当前乘数的最低位，立即给出 ALU 的加法信号与乘积寄存器的写入信号。

    由于下一个时钟上升沿尚未来临，此时被乘数寄存器、乘积寄存器的值均未发生改变，因而与之相连的 ALU 的两个输入信号也是 **旧值**，这恰好是正确的行为。

所以，在当前这个时钟周期中，我们可以同时执行：

-   乘数寄存器右移
-   被乘数寄存器左移
-   ALU 进行加法运算，并写入乘积寄存器。即使被乘数寄存器经过了 **Click-to-Q** 时间，更新了其输出信号，同时 ALU 也使用了 **新值** 计算了，也无需担心，因为此时乘积寄存器早已经过 **Setup Hold** 时间，采样到了旧的 ALU 输出信号完成了更新，所以不会进行二次更新。

如此，在下一个时钟周期到来时，这些寄存器都会得到正确的更新。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 13.55.49@2x.png" alt="CleanShot 2024-03-27 at 13.55.49@2x" style="zoom:30%;" />

这样改进后，在计算一次乘法的时候，同时将被乘数寄存器和乘数寄存器移位，时钟周期变为 1/3。每次乘法只需要 1 个周期。

## 5.4 乘法器的优化 2：减少不必要的硬件资源

### 减少不必要的硬件资源

1. **被乘数寄存器** 是 8 位宽，但其中有效数字始终只有 4 位
2. **乘数寄存器** 是 4 位宽，最开始没有浪费；但其中有效数字每周期减少 1 位，之后有浪费
3. **乘积寄存器** 是 8 位宽，但初始时有效数字只有 4 位，有浪费；之后每周期增加 1 位，最后才没有浪费
4. **加法器** 是 8 位宽，但参与运算的有效数字实际只有 4 位

### 优化方案分析

1. **被乘数寄存器** 缩减为 4 位而且取消左移功能
2. **乘数寄存器** 4 位宽，且带右移。但其中有效数字每周期减少 1 位，取消它，把乘数放进 **乘积寄存器** 低 4 位，借助其右移功能
3. **乘积寄存器** 增加右移功能乘积初始值置于其中高 4 位，随着运算过程不断右移
4. **加法器** 改为 4 位宽，对应的修改其输入信号为被乘数寄存器（4 位宽）和乘积寄存器（高 4 位，4 位宽）

与此同时，控制逻辑也需要做出相应的调整。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.23.38@2x.png" alt="CleanShot 2024-03-27 at 19.23.38@2x" style="zoom:30%;" />

### N 位乘法器的实现结构

本质就是将前文的优化乘法逻辑推广到 N 位乘法器。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.24.27@2x.png" alt="CleanShot 2024-03-27 at 19.24.27@2x" style="zoom:30%;" />

## 5.5 除法的运算过程

### 除法的运算过程（示例 1）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.28.39@2x.png" alt="CleanShot 2024-03-27 at 19.28.39@2x" style="zoom:30%;" />

Dividend = Quotient × Divisor + Remainder

被除数 = 商 × 除数 + 余数

### 除法的运算过程（示例 2）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.32.54@2x.png" alt="CleanShot 2024-03-27 at 19.32.54@2x" style="zoom:30%;" />

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.35.42@2x.png" alt="CleanShot 2024-03-27 at 19.35.42@2x" style="zoom:30%;" />

## 5.6 除法器的实现

### 32-bit 除法器的工作流程图

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.39.19@2x.png" alt="CleanShot 2024-03-27 at 19.39.19@2x" style="zoom:30%;" />

注意这里，判断除法器结束工作的条件是： **判断当前是否是第 33 次循环**。

> 为什么是第 33 次？
>
> 请注意，这里的被除数、余数寄存器都是 64-bit 的，只有除数是 32-bit 的。考虑除数在移位过程中的起始和结束：
>
> 1. 最开始是顶在最高位的（也即从低位 0 开始计数的 63 位）
> 2. 最终停止的时候是在低 32 位的最高 1 位（也即从低位 0 开始计数的 31 位）
>
> 注意，最后顶到右边对齐之后，也会进行一次减法，所以共计是 33 次循环。

### 4-bit 除法器的实现示例

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.41.00@2x.png" alt="CleanShot 2024-03-27 at 19.41.00@2x" style="zoom:30%;" />

### 除法器的工作过程

#### 除法器的工作过程（0）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.45.53@2x.png" alt="CleanShot 2024-03-27 at 19.45.53@2x" style="zoom:30%;" />

#### 除法器的工作过程（1）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.46.58@2x.png" alt="CleanShot 2024-03-27 at 19.46.58@2x" style="zoom:30%;" />

#### 除法器的工作过程（2）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.47.54@2x.png" alt="CleanShot 2024-03-27 at 19.47.54@2x" style="zoom:30%;" />

#### 除法器的工作过程（2b）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.48.41@2x.png" alt="CleanShot 2024-03-27 at 19.48.41@2x" style="zoom:30%;" />

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.49.03@2x.png" alt="CleanShot 2024-03-27 at 19.49.03@2x" style="zoom:30%;" />

#### 除法器的工作过程（3）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.49.34@2x.png" alt="CleanShot 2024-03-27 at 19.49.34@2x" style="zoom:30%;" />

#### 除法器的工作过程（4）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.50.07@2x.png" alt="CleanShot 2024-03-27 at 19.50.07@2x" style="zoom:30%;" />

#### 除法器的工作过程：第二轮（1）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.50.51@2x.png" alt="CleanShot 2024-03-27 at 19.50.51@2x" style="zoom:30%;" />

#### 除法器的工作过程：第二轮～第四轮

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.51.27@2x.png" alt="CleanShot 2024-03-27 at 19.51.27@2x" style="zoom:30%;" />

#### 除法器的工作过程：第五轮（1）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.52.19@2x.png" alt="CleanShot 2024-03-27 at 19.52.19@2x" style="zoom:30%;" />

#### 除法器的工作过程：第五轮（2）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.52.54@2x.png" alt="CleanShot 2024-03-27 at 19.52.54@2x" style="zoom:30%;" />

#### 除法器的工作过程：第五轮（2a）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.53.25@2x.png" alt="CleanShot 2024-03-27 at 19.53.25@2x" style="zoom:30%;" />

#### 除法器的工作过程：第五轮（3）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.54.12@2x.png" alt="CleanShot 2024-03-27 at 19.54.12@2x" style="zoom:30%;" />

注意这里，实际上被除数是移出了 1 位的。

#### 除法器的工作过程：第五轮（4）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.54.41@2x.png" alt="CleanShot 2024-03-27 at 19.54.41@2x" style="zoom:30%;" />

### 32-bit 除法器的实现

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.55.18@2x.png" alt="CleanShot 2024-03-27 at 19.55.18@2x" style="zoom:30%;" />

## 5.7 除法器的优化

### 除法器的实现（第一版）

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 19.57.52@2x.png" alt="CleanShot 2024-03-27 at 19.57.52@2x" style="zoom:30%;" />

### 除法器的面积优化

#### 从减小面积的角度进行分析：

1. 除数寄存器任何时候，实际只用了一半（32/64）
2. 商寄存器初始时是空的，从右到左逐位填满
3. 余数寄存器初始时是满的，随着计算进行，有实际意义的位从左到右逐渐減少

#### 优化方案

1. 除数寄存器缩小为 32-bit，无需支持移位
2. 取消商寄存器
3. 64-bit ALU 缩小为 32-bit
4. 余数寄存器只有高 32-bit 参与加减法运算
5. 余数寄存器需 **同时支持左移和右移**
    - 左移：对应不断向低位看的过程，移出的位不再参与后续计算
    - 右移：对应最后计算完成后取 32-bit 余数的时候
6. 商从右端逐位移入余数寄存器
7. 运算结束时，商占据余数寄存器的低 32-bit

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 20.25.23@2x.png" alt="CleanShot 2024-03-27 at 20.25.23@2x" style="zoom:30%;" />

### 除法的性能优化分析

回顾：乘法的特点

1. 每个部分积都是独立的
2. 可以并行计算各个部分积
3. 条件分支可以通过先进行一步 **对于乘数最低位（1 或 0）的与** 来改为顺序执行

除法有判断，不是独立的（存在依赖关系）。因此，除法的性能优化是有限的。

<img src="./5.乘法器和除法器.assets/CleanShot 2024-03-27 at 20.28.16@2x.png" alt="CleanShot 2024-03-27 at 20.28.16@2x" style="zoom:30%;" />
